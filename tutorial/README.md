# Build your own Programmatic Incremental Build System

A tutorial on building your own programmatic incremental build system, aiming to teach the concepts of PIE.
Live hosted version at: <https://gohla.github.io/pie/>

## Requirements

Install mdBook and several preprocessors:

```shell
cargo install mdbook mdbook-admonish mdbook-external-links
cargo install --path mdbook-diff2html
```

## Building

To test all the code fragments and generate outputs in `gen` which the tutorial uses, first run:

```shell
cd stepper
cargo run
```

Then, to build the tutorial once, run:

```shell
mdbook build
```

Or to interactively build, run:

```shell
mdbook serve
```

## Generate source code

To generate all source code into `stepper/dst`, run:

```shell
cd stepper
cargo run -- step-all -d dst --skip-cargo --skip-outputs
```

## Stack & Structure

The book is built with [mdBook](https://rust-lang.github.io/mdBook/). 
We use the following mdBook plugins:

- [mdbook-admonish](https://github.com/tommilligan/mdbook-admonish)
- [mdbook-external-links](https://github.com/jonahgoldwastaken/mdbook-external-links)

Structure:

- `book.toml`: main mdBook configuration file.
- `src`: book source code.
  - `src/SUMMARY.md`: main mdBook file with the table of contents for the book.
  - `src/custom.css`: custom CSS included with the book.
  - `src/diff.js`: custom JS included with the book for diff highlighting.
  - `src/mdbook-admonish.css`: CSS for the `mdbook-admonish` plugin. This is automatically generated by the plugin.
  - `src/gen`: generated diffs and cargo outputs for the book. Part of `src` for change detection.
  - `src/*`: markdown files and code (diff) fragments of the book.
- `stepper`: command-line application (in Rust) that checks all source code (additions, insertions, diffs) by stepping over them in order and building them with cargo, ensuring that the code in the book is actually valid. It also generates diffs between source code fragments and produces outputs (such as cargo stdout) and stores them in `src/gen`.
  - `stepper/src/app.rs`: stepper instructions. Modify this to modify what/how the source code fragments of the book are checked.
- `mdbook-diff2html`: mdBook preprocessor that renders diffs with [Diff2Html]()

### Diff2Html

Modifications to get it working:

- Replace highlight.js with the newest version, [11.8.0](https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js) at the time of writing.
  - Place that file in `theme/highlight.js`.
  - I did not replace the highlight.js theme (which would go in the `theme/highlight.css` file), as it seems to be working.
  - See [this page](https://cdnjs.com/libraries/highlight.js) for version specific downloads.
- Install Diff2Html JS and CSS files
  - [Download diff2html-ui-base.min.js](https://cdn.jsdelivr.net/npm/diff2html@3.4.42/bundles/js/diff2html-ui-base.min.js) into `src/diff2html-ui-base-.min.js`.
  - [Download diff2html.min.css](https://cdn.jsdelivr.net/npm/diff2html@3.4.42/bundles/css/diff2html.min.css) into `src/diff2html.min.css`.
  - Add those to custom JS and CSS files in `book.toml`.
- Styling modifications
  - Initialize the default mdBook [theme](https://rust-lang.github.io/mdBook/format/theme/index.html) into `theme`.
  - Remove things that we don't need to override: *.hbs files, favicon, fonts.
  - Modify `theme/general.css`, `theme/chrome.css`, `theme/highlight.css`, and `src/diff2html.min.css`. Changes are denoted with `CHANGE`.
  - Note that we're modifying generated files here: `theme/highlight.css`, `src/diff2html.min.css`. Updating will be difficult.
